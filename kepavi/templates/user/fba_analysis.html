{% extends "sidebar_layout.html" %}

{% block title %}
    Visualize network
{% endblock %}

{% block keywords %}
    <meta name="keywords" content="metabomatch, about">
    <meta name="description" content="The reasons why we made metabomatch">
{% endblock %}

{% block css %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/chosen.min.css') }}">
    <style>
        .meta-loader {
            display: none;
        }

        .load-cytoscape-btn {
            margin-top: 50px;
        }

        #cytoscape-container {
            height:100%;
        }

    hr {
        border: 1px solid white;
{#        border: 1px solid black;#}
    }
        #centered-loader {
            position:absolute;
            top: 50%;
            bottom: 50%;
            left: 50%;
            right: 50%;
            z-index: 1;
            display: none;
        }

        .help-block { font-size: 0.8em;}
    </style>
    <link href="http://cdnjs.cloudflare.com/ajax/libs/qtip2/2.2.0/jquery.qtip.min.css" rel="stylesheet" type="text/css" />

{% endblock %}

{% block content %}
    <div id="centered-loader"><span class="fa fa-circle-o-notch fa-spin fa-3x"></span></div>
    <form>
        <div class="row">
            <div class="col-md-5">
                <h2>1. Select an Organism</h2>

                <div class="form-group">
                    <select class="org_selector" style="width:75%">
                        <option value="none" selected disabled>Choose an organism...</option>
                        {% for o in organisms %}
                            <option value="{{ o.org }}" {% if o.tax == model_name %} selected {% endif %}>{{ o.tax }}</option>
                        {% endfor %}
                    </select>
                    <p class="help-block">Pathway are loaded when you choose an organism. <span class="meta-loader fa fa-circle-o-notch fa-spin"></span></p>
                </div>
            </div>
            <div class="col-md-5">
                <h2>2. Select a pathway</h2>
                 <div class="form-group">
                    <select class="pathway_selector" style="width:75%">
                        {# <option value="none" selected disabled>Choose a pathway...</option> #}
                        <option value="whole">Whole model</option>
                        {% for pathway in pathways %}
                            <option value="{{pathway['id']}}">{{pathway['name'].split(' - ') | first}}</option>
                        {% endfor %}
                    </select>
                    <p id="help" class="help-block">Choose an organism first.</p>
                 </div>
            </div>
            <div class="col-md-2">
                <button class="load-cytoscape-btn btn btn-info">Load pathway</button>
            </div>
        </div>
    </form>
    <div class="row">
        <div id="cytoscape-container" style="height: 600px; border: 3px solid black">

        </div>
    </div>
{% endblock %}

{% block scripts %}
    {# <script src="{{ url_for('static', filename='js/arbor.js') }}"></script> #}
    {# <script src="{{ url_for('static', filename='js/cola.v3.min.js') }}"></script> #}
    {# <script src="{{ url_for('static', filename='js/cytoscape.min.js') }}"></script> #}
    {# <script src="http://cdnjs.cloudflare.com/ajax/libs/qtip2/2.2.0/jquery.qtip.min.js"></script>
    <script src="{{ url_for('static', filename='js/cytoscape.qtip.js') }}"></script> #}
    <script src="{{ url_for('static', filename='js/sigma.min.js')}}"></script>
    <script src="{{ url_for('static', filename='js/plugins/sigma.parsers.json.min.js')}}"></script>
    <script src="{{ url_for('static', filename='js/plugins/sigma.layout.forceAtlas2.min.js')}}"></script>
    <script src="{{ url_for('static', filename='js/plugins/sigma.plugins.dragNodes.min.js')}}"></script>
    <script src="{{ url_for('static', filename='js/chosen.jquery.min.js')}}"></script>
    <script>
        $(function() {

            //$('.sidebar-menu').css('height', $(document).height() + 'px'); 

            var org_selector = $(".org_selector");
            org_selector.chosen({
                no_results_text: "No match found..."
            });

            var pathway_selector = $('.pathway_selector');
            // pathway_selector.attr('disabled');
            //pathway_selector.chosen({no_results_text: "No match found..."});

            console.log(pathway_selector);
            var meta_loader = $('.meta-loader');

            org_selector.on('change', function(evt, params){

                // remove all options
                $('.pathway_selector option').remove();
                $('#help').css('display', 'none');
                console.log('on change event');
                meta_loader.css('display', 'inline');
                console.log(params['selected']);
                $.get("{{ url_for('home.get_pathways') }}?org=" + params['selected'],
                        function(data){
                            console.log("populating patwhay...");
                            for (i=0,l=data.length; i < l; ++i) {
                                var d = data[i];
                                pathway_selector.append($('<option>', {value: d['id'], text:d['name']}));
                            }
                            console.log('done');
                            $('.load-cytoscape-btn').removeAttr('disabled');
                            pathway_selector.removeAttr('disabled');

                            meta_loader.css('display', 'none');
                        },
                        "json");
            });

            /** get some kgml data */
            $('.load-cytoscape-btn').on('click', function(evt){
                evt.preventDefault();
                var pathway_id = pathway_selector.val();
                var pathway_name = $('.pathway_selector option:selected').text();
                $('#centered-loader').css('display', 'inline');
                $.get("{{ url_for('user.get_kgml', username=current_user.username) }}?pathway_name=" + pathway_name + "&pathway_id=" + pathway_id + "&analysis_id=" + "{{ analysis.id }}",
                        function(data){
                            sigma.renderers.def = sigma.renderers.canvas
                            s = new sigma({
                                graph: JSON.parse(data),
                                container: 'cytoscape-container',
                                settings: {
                                    //defaultNodeColor: '#ec5148'
                                }
                            });
                            s.refresh();
                            var dragListener = sigma.plugins.dragNodes(s, s.renderers[0]);
                            // s.startForceAtlas2();
                            console.log('sigma loaded');
                            $('#centered-loader').css('display', 'none');
                            // sigma.parsers.json(data, {
                            //   container: 'cytoscape-container'
                            // });
                        }
                );
            });
                           
        });
    </script>
{% endblock %}
